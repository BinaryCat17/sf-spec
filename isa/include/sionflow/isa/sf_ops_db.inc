#ifndef SF_OPS_DB_INC
#define SF_OPS_DB_INC

/**
 * SionFlow Operation Opcodes (The VM Instructions)
 */
#define SF_OPCODE_LIST \
    SF_OPCODE(NOOP, 0) \
    SF_OPCODE(ADD, 1) \
    SF_OPCODE(SUB, 2) \
    SF_OPCODE(MUL, 3) \
    SF_OPCODE(DIV, 4) \
    SF_OPCODE(MIN, 10) \
    SF_OPCODE(MAX, 11) \
    SF_OPCODE(ABS, 12) \
    SF_OPCODE(CLAMP, 13) \
    SF_OPCODE(STEP, 15) \
    SF_OPCODE(FLOOR, 20) \
    SF_OPCODE(CEIL, 21) \
    SF_OPCODE(SIN, 22) \
    SF_OPCODE(COS, 23) \
    SF_OPCODE(ATAN2, 24) \
    SF_OPCODE(SQRT, 25) \
    SF_OPCODE(POW, 26) \
    SF_OPCODE(SUM, 27) \
    SF_OPCODE(FMA, 29) \
    SF_OPCODE(MATMUL, 40) \
    SF_OPCODE(TRANSPOSE, 41) \
    SF_OPCODE(INVERSE, 42) \
    SF_OPCODE(DOT, 43) \
    SF_OPCODE(LENGTH, 44) \
    SF_OPCODE(NORMALIZE, 45) \
    SF_OPCODE(JOIN, 46) \
    SF_OPCODE(MIX, 47) \
    SF_OPCODE(SMOOTHSTEP, 48) \
    SF_OPCODE(LESS, 60) \
    SF_OPCODE(GREATER, 61) \
    SF_OPCODE(EQUAL, 62) \
    SF_OPCODE(NEQUAL, 63) \
    SF_OPCODE(LEQUAL, 64) \
    SF_OPCODE(GEQUAL, 65) \
    SF_OPCODE(AND, 80) \
    SF_OPCODE(OR, 81) \
    SF_OPCODE(XOR, 82) \
    SF_OPCODE(NOT, 83) \
    SF_OPCODE(SELECT, 100) \
    SF_OPCODE(SIZE, 110) \
    SF_OPCODE(GATHER, 262) \
    SF_OPCODE(CUMSUM, 270) \
    SF_OPCODE(COMPRESS, 280) \
    SF_OPCODE(COPY, 520) \
    SF_OPCODE(SLICE, 521) \
    SF_OPCODE(RESHAPE, 522)

/**
 * SionFlow Compiler Nodes (JSON Interface & Logic)
 * 
 * Format:
 * SF_OP(node_suffix, json_name, opcode_suffix, category, strategy, in_mask, out_mask, type_rule, shape_rule, access_rule, p1, p2, p3, p4, ktype, kexpr, karity)
 */

/* --- Semantic Wrappers --- */
#define SF_MATH_BIN(node, json, opcode, expr) \
    SF_OP(node, json, opcode, SF_OP_CAT_ATOMIC, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST, SF_ACCESS_LINEAR, "a", "b", NULL, NULL, AUTO, expr, 2)

#define SF_MATH_UNARY(node, json, opcode, expr) \
    SF_OP(node, json, opcode, SF_OP_CAT_ATOMIC, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR, "in", NULL, NULL, NULL, AUTO, expr, 1)

#define SF_LOGIC_BIN(node, json, opcode, expr) \
    SF_OP(node, json, opcode, SF_OP_CAT_ATOMIC, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL, SF_TYPE_MASK_LOGIC, SF_OUT_FORCE_U8, SF_SHAPE_BROADCAST, SF_ACCESS_LINEAR, "a", "b", NULL, NULL, AUTO, expr, 2)

#define SF_OP_LIST \
    /* --- Special Nodes (Compiler Intrinsics) --- */ \
    SF_OP(CONST,   "Const",   NOOP,    SF_OP_CAT_SPECIAL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SPECIAL,    SF_ACCESS_SPECIAL, NULL,  NULL,  NULL,  NULL, MANUAL, NULL, 0) \
    SF_OP(INPUT,   "Input",   NOOP,    SF_OP_CAT_SPECIAL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SPECIAL,    SF_ACCESS_SPECIAL, NULL,  NULL,  NULL,  NULL, MANUAL, NULL, 0) \
    SF_OP(OUTPUT,  "Output",  COPY,    SF_OP_CAT_SPECIAL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SPECIAL,    SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(CALL,    "Call",    NOOP,    SF_OP_CAT_SPECIAL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SPECIAL,    SF_ACCESS_SPECIAL, NULL,  NULL,  NULL,  NULL, MANUAL, NULL, 0) \
    SF_OP(COPY,    "Copy",    COPY,    SF_OP_CAT_SPECIAL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Atomic Math (1:1 element mapping) --- */ \
    SF_MATH_BIN(ADD,     "Add",     ADD,     (va + vb)) \
    SF_MATH_BIN(SUB,     "Sub",     SUB,     (va - vb)) \
    SF_MATH_BIN(MUL,     "Mul",     MUL,     (va * vb)) \
    SF_MATH_BIN(DIV,     "Div",     DIV,     (va / vb)) \
    SF_MATH_UNARY(ABS,     "Abs",     ABS,     fabsf(va)) \
    SF_OP(SIN,     "Sin",     SIN,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, sinf(va), 1) \
    SF_OP(COS,     "Cos",     COS,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, cosf(va), 1) \
    SF_OP(SQRT,    "Sqrt",    SQRT,    SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, sqrtf(va), 1) \
    SF_OP(FLOOR,   "Floor",   FLOOR,   SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, floorf(va), 1) \
    SF_OP(CEIL,    "Ceil",    CEIL,    SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, ceilf(va), 1) \
    SF_OP(POW,     "Pow",     POW,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "base","exp", NULL,  NULL, AUTO, powf(va, vb), 2) \
    SF_OP(ATAN2,   "Atan2",   ATAN2,   SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "y",   "x",   NULL,  NULL, AUTO, atan2f(va, vb), 2) \
    SF_MATH_BIN(MIN,     "Min",     MIN,     (va < vb ? va : vb)) \
    SF_MATH_BIN(MAX,     "Max",     MAX,     (va > vb ? va : vb)) \
    SF_OP(FMA,     "Fma",     FMA,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "a",   "b",   "c",   NULL, AUTO, fmaf(va, vb, vc), 3) \
    SF_OP(CLAMP,   "Clamp",   CLAMP,   SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "x",   "min", "max", NULL, AUTO, fminf(fmaxf(va, vb), vc), 3) \
    SF_OP(STEP,    "Step",    STEP,    SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "edge","x",   NULL,  NULL, AUTO, (vb < va ? 0.0f : 1.0f), 2) \
    SF_OP(MIX,     "Mix",     MIX,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "a",   "b",   "t",   NULL, AUTO, (va * (1.0f - vc) + vb * vc), 3) \
    SF_OP(SMOOTHSTEP,"SmoothStep",SMOOTHSTEP,SF_OP_CAT_ATOMIC,SF_STRATEGY_DEFAULT,SF_TYPE_MASK_F32, SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S2, SF_ACCESS_LINEAR,  "edges","x",  NULL,  NULL, MANUAL, NULL, 2) \
    SF_OP(SELECT,  "Select",  SELECT,  SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT_2, SF_SHAPE_BROADCAST,SF_ACCESS_LINEAR,  "cond","true","false",NULL, AUTO, (va ? vb : vc), 3) \
    \
    /* --- Atomic Logic --- */ \
    SF_LOGIC_BIN(LESS,    "Less",    LESS,    (va < vb)) \
    SF_LOGIC_BIN(GREATER, "Greater", GREATER, (va > vb)) \
    SF_LOGIC_BIN(EQUAL,   "Equal",   EQUAL,   (va == vb)) \
    SF_LOGIC_BIN(NEQUAL,  "NotEqual",NEQUAL,  (va != vb)) \
    SF_LOGIC_BIN(LEQUAL,  "LessEqual",LEQUAL, (va <= vb)) \
    SF_LOGIC_BIN(GEQUAL,  "GreaterEqual",GEQUAL, (va >= vb)) \
    SF_OP(AND,     "And",     AND,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_LOGIC,   SF_TYPE_MASK_LOGIC,   SF_OUT_FORCE_U8,      SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va && vb), 2) \
    SF_OP(OR,      "Or",      OR,      SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_LOGIC,   SF_TYPE_MASK_LOGIC,   SF_OUT_FORCE_U8,      SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va || vb), 2) \
    SF_OP(XOR,     "Xor",     XOR,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_LOGIC,   SF_TYPE_MASK_LOGIC,   SF_OUT_FORCE_U8,      SF_SHAPE_BROADCAST,  SF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, ((int)va != (int)vb), 2) \
    SF_OP(NOT,     "Not",     NOT,     SF_OP_CAT_ATOMIC,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_LOGIC,   SF_OUT_FORCE_U8,      SF_SHAPE_SAME_AS_S1, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, (!va), 1) \
    \
    /* --- Reductions --- */ \
    SF_OP(REDUCE_SUM, "ReduceSum", SUM, SF_OP_CAT_REDUCTION, SF_STRATEGY_REDUCTION, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_SCALAR,    SF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(DOT,        "Dot",       DOT,     SF_OP_CAT_REDUCTION, SF_STRATEGY_REDUCTION, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_DOT,       SF_ACCESS_WINDOW,  "a",   "b",   NULL,  NULL, MANUAL, NULL, 2) \
    SF_OP(LENGTH,     "Length",    LENGTH,  SF_OP_CAT_REDUCTION, SF_STRATEGY_REDUCTION, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_DOT,       SF_ACCESS_WINDOW,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(SIZE,       "Size",      SIZE,    SF_OP_CAT_REDUCTION, SF_STRATEGY_REDUCTION, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SCALAR,    SF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(CUMSUM,  "CumSum",  CUMSUM,  SF_OP_CAT_REDUCTION, SF_STRATEGY_TWO_PASS_SYNC, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_SAME_AS_S1, SF_ACCESS_GLOBAL, "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Accelerators --- */ \
    SF_OP(MATMUL,  "MatMul",    MATMUL,    SF_OP_CAT_ACCEL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_NUMERIC, SF_TYPE_MASK_NUMERIC, SF_OUT_SAME_AS_INPUT, SF_SHAPE_MATMUL,    SF_ACCESS_WINDOW,  "a",   "b",   NULL,  NULL, MANUAL, NULL, 2) \
    SF_OP(INVERSE, "Inverse",   INVERSE,   SF_OP_CAT_ACCEL, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Memory & Layout --- */ \
    SF_OP(TRANSPOSE,"Transpose", TRANSPOSE, SF_OP_CAT_MEMORY, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_TRANSPOSE, SF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(NORMALIZE,"Normalize", NORMALIZE, SF_OP_CAT_MEMORY, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_F32,     SF_TYPE_MASK_F32,     SF_OUT_FORCE_F32,     SF_SHAPE_SAME_AS_S1, SF_ACCESS_WINDOW,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    SF_OP(JOIN,    "Join",      JOIN,      SF_OP_CAT_MEMORY, SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_JOIN,      SF_ACCESS_LINEAR,  "a",   "b",   "c",   "d",  MANUAL, NULL, 4) \
    SF_OP(GATHER,  "Gather",  GATHER,  SF_OP_CAT_MEMORY,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_GATHER,     SF_ACCESS_RANDOM,  "data", "indices", NULL, NULL, MANUAL, NULL, 2) \
    SF_OP(COMPRESS,"Filter",  COMPRESS,SF_OP_CAT_MEMORY,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SAME_AS_S1, SF_ACCESS_RANDOM,  "in",   "mask", NULL, NULL, MANUAL, NULL, 2) \
    SF_OP(SLICE,   "Slice",   SLICE,   SF_OP_CAT_MEMORY,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_SLICE,      SF_ACCESS_LINEAR,  "in",   "range", NULL, NULL, MANUAL, NULL, 2) \
    SF_OP(RESHAPE, "Reshape", RESHAPE, SF_OP_CAT_MEMORY,  SF_STRATEGY_DEFAULT, SF_TYPE_MASK_ALL,     SF_TYPE_MASK_ALL,     SF_OUT_SAME_AS_INPUT, SF_SHAPE_RESHAPE,    SF_ACCESS_LINEAR,  "in",   "shape", NULL, NULL, MANUAL, NULL, 2)

#endif // SF_OPS_DB_INC